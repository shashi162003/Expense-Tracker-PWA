<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üí∏ Expense Tracker API - Debug Console</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .main-content {
        display: grid;
        grid-template-columns: 300px 1fr;
        min-height: 80vh;
      }

      .sidebar {
        background: #f8f9fa;
        padding: 20px;
        border-right: 1px solid #e9ecef;
      }

      .nav-section {
        margin-bottom: 30px;
      }

      .nav-section h3 {
        color: #495057;
        margin-bottom: 15px;
        font-size: 1.1em;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 5px;
      }

      .nav-item {
        display: block;
        padding: 12px 15px;
        margin: 5px 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        text-decoration: none;
        color: #495057;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .nav-item:hover,
      .nav-item.active {
        background: #667eea;
        color: white;
        transform: translateX(5px);
      }

      .content-area {
        padding: 30px;
        overflow-y: auto;
      }

      .section {
        display: none;
        animation: fadeIn 0.3s ease;
      }

      .section.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #495057;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      .btn:hover {
        background: #5a6fd8;
        transform: translateY(-2px);
      }

      .btn-success {
        background: #28a745;
      }
      .btn-success:hover {
        background: #218838;
      }

      .btn-danger {
        background: #dc3545;
      }
      .btn-danger:hover {
        background: #c82333;
      }

      .btn-warning {
        background: #ffc107;
        color: #212529;
      }
      .btn-warning:hover {
        background: #e0a800;
      }

      .response-area {
        background: #f8f9fa;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
        font-family: "Courier New", monospace;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-online {
        background: #28a745;
      }
      .status-offline {
        background: #dc3545;
      }

      .auth-status {
        background: #e9ecef;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      .card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
      }

      .card h4 {
        color: #495057;
        margin-bottom: 15px;
        border-bottom: 1px solid #dee2e6;
        padding-bottom: 10px;
      }

      .expense-item {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        border-left: 4px solid #667eea;
      }

      .expense-item h5 {
        color: #495057;
        margin-bottom: 5px;
      }

      .expense-item p {
        color: #6c757d;
        margin: 2px 0;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
      }

      .alert-error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }

      .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üí∏ Expense Tracker API</h1>
        <p>Debug Console & Feature Testing Interface</p>
        <div style="margin-top: 15px">
          <span class="status-indicator" id="apiStatus"></span>
          <span id="apiStatusText">Checking API status...</span>
        </div>
      </div>

      <div class="main-content">
        <div class="sidebar">
          <div class="nav-section">
            <h3>üîê Authentication</h3>
            <div class="nav-item" onclick="showSection('auth')">
              Login & Register
            </div>
            <div class="nav-item" onclick="showSection('profile')">
              Profile Management
            </div>
          </div>

          <div class="nav-section">
            <h3>üí∞ Expenses</h3>
            <div class="nav-item" onclick="showSection('expenses')">
              Manage Expenses
            </div>
            <div class="nav-item" onclick="showSection('categories')">
              Categories
            </div>
          </div>

          <div class="nav-section">
            <h3>üìä Reports</h3>
            <div class="nav-item" onclick="showSection('reports')">
              View Reports
            </div>
            <div class="nav-item" onclick="showSection('dashboard')">
              Dashboard
            </div>
          </div>

          <div class="nav-section">
            <h3>üìß Email & Cron</h3>
            <div class="nav-item" onclick="showSection('email')">
              Email Testing
            </div>
            <div class="nav-item" onclick="showSection('cron')">Cron Jobs</div>
          </div>

          <div class="nav-section">
            <h3>‚öôÔ∏è System</h3>
            <div class="nav-item" onclick="showSection('status')">
              API Status
            </div>
            <div class="nav-item" onclick="showSection('docs')">
              Documentation
            </div>
          </div>
        </div>

        <div class="content-area">
          <div class="auth-status" id="authStatus">
            <strong>Authentication Status:</strong>
            <span id="authStatusText">Not logged in</span>
            <button
              class="btn btn-danger"
              onclick="logout()"
              id="logoutBtn"
              style="display: none; float: right"
            >
              Logout
            </button>
          </div>

          <!-- Authentication Section -->
          <div id="auth" class="section active">
            <h2>üîê Authentication</h2>

            <div class="grid-2">
              <div class="card">
                <h4>Register New User</h4>
                <div class="form-group">
                  <label>Username:</label>
                  <input
                    type="text"
                    id="regUsername"
                    placeholder="Enter username"
                  />
                </div>
                <div class="form-group">
                  <label>Email:</label>
                  <input type="email" id="regEmail" placeholder="Enter email" />
                </div>
                <div class="form-group">
                  <label>Password:</label>
                  <input
                    type="password"
                    id="regPassword"
                    placeholder="Enter password"
                  />
                </div>
                <div class="form-group">
                  <label>Weekly Limit (‚Çπ):</label>
                  <input
                    type="number"
                    id="regWeeklyLimit"
                    placeholder="Optional weekly spending limit in INR"
                  />
                </div>
                <button class="btn btn-success" onclick="register()">
                  Register
                </button>
              </div>

              <div class="card">
                <h4>Login</h4>
                <div class="form-group">
                  <label>Email:</label>
                  <input
                    type="email"
                    id="loginEmail"
                    placeholder="Enter email"
                  />
                </div>
                <div class="form-group">
                  <label>Password:</label>
                  <input
                    type="password"
                    id="loginPassword"
                    placeholder="Enter password"
                  />
                </div>
                <button class="btn" onclick="login()">Login</button>
              </div>
            </div>

            <div class="response-area" id="authResponse"></div>
          </div>

          <!-- Profile Section -->
          <div id="profile" class="section">
            <h2>üë§ Profile Management</h2>

            <div class="card">
              <h4>Current Profile</h4>
              <button class="btn" onclick="getProfile()">Load Profile</button>
              <div id="profileData"></div>
            </div>

            <div class="grid-2">
              <div class="card">
                <h4>Update Profile</h4>
                <div class="form-group">
                  <label>Username:</label>
                  <input
                    type="text"
                    id="updateUsername"
                    placeholder="New username"
                  />
                </div>
                <div class="form-group">
                  <label>Email:</label>
                  <input
                    type="email"
                    id="updateEmail"
                    placeholder="New email"
                  />
                </div>
                <button class="btn" onclick="updateProfile()">
                  Update Profile
                </button>
              </div>

              <div class="card">
                <h4>Change Password</h4>
                <div class="form-group">
                  <label>Current Password:</label>
                  <input
                    type="password"
                    id="currentPassword"
                    placeholder="Current password"
                  />
                </div>
                <div class="form-group">
                  <label>New Password:</label>
                  <input
                    type="password"
                    id="newPassword"
                    placeholder="New password"
                  />
                </div>
                <button class="btn btn-warning" onclick="changePassword()">
                  Change Password
                </button>
              </div>
            </div>

            <div class="response-area" id="profileResponse"></div>
          </div>

          <!-- Expenses Section -->
          <div id="expenses" class="section">
            <h2>üí∞ Expense Management</h2>

            <div class="grid-2">
              <div class="card">
                <h4>Add New Expense</h4>
                <div class="form-group">
                  <label>Title:</label>
                  <input
                    type="text"
                    id="expenseTitle"
                    placeholder="Expense title"
                  />
                </div>
                <div class="form-group">
                  <label>Amount (‚Çπ):</label>
                  <input
                    type="number"
                    step="0.01"
                    id="expenseAmount"
                    placeholder="0.00"
                  />
                </div>
                <div class="form-group">
                  <label>Category:</label>
                  <select id="expenseCategory">
                    <option value="">Select category</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Date:</label>
                  <input type="date" id="expenseDate" />
                </div>
                <div class="form-group">
                  <label>Note:</label>
                  <textarea
                    id="expenseNote"
                    placeholder="Optional note"
                    rows="3"
                  ></textarea>
                </div>
                <button class="btn btn-success" onclick="addExpense()">
                  Add Expense
                </button>
              </div>

              <div class="card">
                <h4>Filter Expenses</h4>
                <div class="form-group">
                  <label>Category:</label>
                  <select id="filterCategory">
                    <option value="">All categories</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Start Date:</label>
                  <input type="date" id="filterStartDate" />
                </div>
                <div class="form-group">
                  <label>End Date:</label>
                  <input type="date" id="filterEndDate" />
                </div>
                <div class="form-group">
                  <label>Search:</label>
                  <input
                    type="text"
                    id="filterSearch"
                    placeholder="Search title or note"
                  />
                </div>
                <button class="btn" onclick="loadExpenses()">
                  Load Expenses
                </button>
                <button class="btn btn-warning" onclick="clearFilters()">
                  Clear Filters
                </button>
              </div>
            </div>

            <div class="card">
              <h4>Your Expenses</h4>
              <div id="expensesList"></div>
            </div>

            <div class="response-area" id="expenseResponse"></div>
          </div>

          <!-- Categories Section -->
          <div id="categories" class="section">
            <h2>üìÇ Categories</h2>

            <div class="card">
              <h4>Available Categories</h4>
              <button class="btn" onclick="loadCategoriesDisplay()">
                Load Categories
              </button>
              <div id="categoriesDisplay"></div>
            </div>
          </div>

          <!-- Reports Section -->
          <div id="reports" class="section">
            <h2>üìä Reports & Analytics</h2>

            <div class="grid-2">
              <div class="card">
                <h4>Monthly Report</h4>
                <div class="form-group">
                  <label>Year:</label>
                  <input type="number" id="monthlyYear" value="2024" />
                </div>
                <div class="form-group">
                  <label>Month:</label>
                  <select id="monthlyMonth">
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                  </select>
                </div>
                <button class="btn" onclick="getMonthlyReport()">
                  Get Monthly Report
                </button>
              </div>

              <div class="card">
                <h4>Weekly Report</h4>
                <div class="form-group">
                  <label>Week Offset:</label>
                  <select id="weekOffset">
                    <option value="0">Current Week</option>
                    <option value="-1">Last Week</option>
                    <option value="-2">2 Weeks Ago</option>
                    <option value="-3">3 Weeks Ago</option>
                  </select>
                </div>
                <button class="btn" onclick="getWeeklyReport()">
                  Get Weekly Report
                </button>
              </div>
            </div>

            <div class="card">
              <h4>Category Summary</h4>
              <div class="form-group">
                <label>Period:</label>
                <select id="categoryPeriod">
                  <option value="week">This Week</option>
                  <option value="month">This Month</option>
                  <option value="year">This Year</option>
                </select>
              </div>
              <button class="btn" onclick="getCategoryReport()">
                Get Category Report
              </button>
            </div>

            <div class="card">
              <h4>üìß Email Reports</h4>
              <p>Send detailed reports directly to your email:</p>
              <div class="grid-2">
                <div>
                  <button
                    class="btn btn-success"
                    onclick="emailMonthlyReport()"
                  >
                    üìß Email Monthly Report
                  </button>
                  <button class="btn btn-success" onclick="emailWeeklyReport()">
                    üìß Email Weekly Report
                  </button>
                </div>
                <div>
                  <button
                    class="btn btn-success"
                    onclick="emailCategoryReport()"
                  >
                    üìß Email Category Report
                  </button>
                </div>
              </div>
              <div class="alert alert-warning" style="margin-top: 15px">
                <strong>Note:</strong> Reports will be sent to your registered
                email address with beautiful HTML formatting.
              </div>
            </div>

            <div class="response-area" id="reportsResponse"></div>
          </div>

          <!-- Dashboard Section -->
          <div id="dashboard" class="section">
            <h2>üìà Dashboard</h2>

            <div class="card">
              <h4>User Dashboard</h4>
              <button class="btn" onclick="getDashboard()">
                Load Dashboard
              </button>
              <button class="btn btn-success" onclick="getWeeklyStatus()">
                Weekly Status
              </button>
              <div id="dashboardData"></div>
            </div>

            <div class="card">
              <h4>Set Weekly Limit</h4>
              <div class="form-group">
                <label>Weekly Spending Limit (‚Çπ):</label>
                <input
                  type="number"
                  step="0.01"
                  id="weeklyLimitAmount"
                  placeholder="Enter weekly limit in INR"
                />
              </div>
              <button class="btn btn-warning" onclick="setWeeklyLimit()">
                Set Weekly Limit
              </button>
            </div>

            <div class="response-area" id="dashboardResponse"></div>
          </div>

          <!-- Email Section -->
          <div id="email" class="section">
            <h2>üìß Email Testing</h2>

            <div class="card">
              <h4>Email Functions</h4>
              <button class="btn btn-success" onclick="sendTestEmail()">
                Send Test Email
              </button>
              <button class="btn" onclick="triggerDailySummary()">
                Trigger Daily Summary
              </button>
              <button class="btn" onclick="checkWeeklyLimit()">
                Check Weekly Limit
              </button>
            </div>

            <div class="card">
              <h4>Email Configuration Test</h4>
              <p>
                This will test if your email configuration is working properly.
              </p>
              <div class="alert alert-warning">
                <strong>Note:</strong> Make sure you have configured EMAIL_USER
                and EMAIL_PASS in your .env file.
              </div>
            </div>

            <div class="response-area" id="emailResponse"></div>
          </div>

          <!-- Cron Jobs Section -->
          <div id="cron" class="section">
            <h2>‚è∞ Cron Jobs Management</h2>

            <div class="card">
              <h4>Cron Job Status</h4>
              <button class="btn" onclick="getCronStatus()">
                Get Cron Status
              </button>
              <div id="cronStatusDisplay"></div>
            </div>

            <div class="card">
              <h4>Manual Triggers</h4>
              <p>
                These buttons will manually trigger the cron job functions for
                testing:
              </p>
              <div class="grid-2">
                <div>
                  <button
                    class="btn btn-success"
                    onclick="triggerDailySummary()"
                  >
                    üî• Trigger Daily Summary
                  </button>
                  <button
                    class="btn btn-success"
                    onclick="triggerWeeklySummary()"
                  >
                    üî• Trigger Weekly Summary
                  </button>
                </div>
                <div>
                  <button
                    class="btn btn-warning"
                    onclick="triggerWeeklyLimitCheck()"
                  >
                    üî• Trigger Weekly Limit Check
                  </button>
                  <button class="btn" onclick="testAllCronJobs()">
                    üß™ Test All Cron Jobs
                  </button>
                </div>
              </div>
              <div class="alert alert-warning">
                <strong>Note:</strong> These will send actual emails!
                Daily/Weekly summaries go to all users, Weekly limit check is
                for your account only.
              </div>
            </div>

            <div class="response-area" id="cronResponse"></div>
          </div>

          <!-- API Status Section -->
          <div id="status" class="section">
            <h2>‚öôÔ∏è API Status & Health</h2>

            <div class="card">
              <h4>System Status</h4>
              <button class="btn" onclick="getSystemStatus()">
                Get System Status
              </button>
              <button class="btn btn-success" onclick="healthCheck()">
                Health Check
              </button>
              <div id="systemStatusDisplay"></div>
            </div>

            <div class="card">
              <h4>Database Connection</h4>
              <button class="btn" onclick="testDatabaseConnection()">
                Test Database
              </button>
              <div id="databaseStatus"></div>
            </div>

            <div class="response-area" id="statusResponse"></div>
          </div>

          <!-- Documentation Section -->
          <div id="docs" class="section">
            <h2>üìö API Documentation</h2>

            <div class="card">
              <h4>API Endpoints</h4>
              <button class="btn" onclick="getApiDocs()">
                Load API Documentation
              </button>
              <div id="apiDocsDisplay"></div>
            </div>

            <div class="card">
              <h4>Quick Reference</h4>
              <div class="alert alert-success">
                <h5>Base URL:</h5>
                <code>http://localhost:5000/api</code>

                <h5 style="margin-top: 15px">Authentication:</h5>
                <code>Authorization: Bearer &lt;token&gt;</code>

                <h5 style="margin-top: 15px">Content-Type:</h5>
                <code>application/json</code>
              </div>
            </div>

            <div class="response-area" id="docsResponse"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:5000/api";
      let authToken = localStorage.getItem("authToken");
      let currentUser = null;

      // Initialize the page
      document.addEventListener("DOMContentLoaded", function () {
        checkApiStatus();
        loadCategories();
        setDefaultDate();

        if (authToken) {
          updateAuthStatus(true);
          getProfile();
        }
      });

      // Navigation
      function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll(".section").forEach((section) => {
          section.classList.remove("active");
        });

        // Remove active class from nav items
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });

        // Show selected section
        document.getElementById(sectionId).classList.add("active");

        // Add active class to clicked nav item
        event.target.classList.add("active");
      }

      // API Status Check
      async function checkApiStatus() {
        try {
          const response = await fetch(`${API_BASE}/status`);
          const data = await response.json();

          document.getElementById("apiStatus").className =
            "status-indicator status-online";
          document.getElementById("apiStatusText").textContent = "API Online";
        } catch (error) {
          document.getElementById("apiStatus").className =
            "status-indicator status-offline";
          document.getElementById("apiStatusText").textContent = "API Offline";
        }
      }

      // Authentication functions
      async function register() {
        const username = document.getElementById("regUsername").value;
        const email = document.getElementById("regEmail").value;
        const password = document.getElementById("regPassword").value;
        const weeklyLimit = document.getElementById("regWeeklyLimit").value;

        try {
          const response = await fetch(`${API_BASE}/auth/register`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username,
              email,
              password,
              weeklyLimit: weeklyLimit ? parseFloat(weeklyLimit) : 0,
            }),
          });

          const data = await response.json();
          document.getElementById("authResponse").textContent = JSON.stringify(
            data,
            null,
            2
          );

          if (data.success) {
            authToken = data.data.token;
            localStorage.setItem("authToken", authToken);
            currentUser = data.data.user;
            updateAuthStatus(true);
          }
        } catch (error) {
          document.getElementById("authResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function login() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        try {
          const response = await fetch(`${API_BASE}/auth/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email, password }),
          });

          const data = await response.json();
          document.getElementById("authResponse").textContent = JSON.stringify(
            data,
            null,
            2
          );

          if (data.success) {
            authToken = data.data.token;
            localStorage.setItem("authToken", authToken);
            currentUser = data.data.user;
            updateAuthStatus(true);
          }
        } catch (error) {
          document.getElementById("authResponse").textContent =
            "Error: " + error.message;
        }
      }

      function logout() {
        authToken = null;
        currentUser = null;
        localStorage.removeItem("authToken");
        updateAuthStatus(false);
        document.getElementById("authResponse").textContent =
          "Logged out successfully";
      }

      function updateAuthStatus(isLoggedIn) {
        const statusText = document.getElementById("authStatusText");
        const logoutBtn = document.getElementById("logoutBtn");

        if (isLoggedIn && currentUser) {
          statusText.textContent = `Logged in as ${currentUser.username} (${currentUser.email})`;
          logoutBtn.style.display = "inline-block";
        } else {
          statusText.textContent = "Not logged in";
          logoutBtn.style.display = "none";
        }
      }

      // Helper function for authenticated requests
      async function authenticatedFetch(url, options = {}) {
        if (!authToken) {
          throw new Error("Not authenticated");
        }

        const headers = {
          "Content-Type": "application/json",
          Authorization: `Bearer ${authToken}`,
          ...options.headers,
        };

        return fetch(url, { ...options, headers });
      }

      // Load categories
      async function loadCategories() {
        try {
          // Categories are now public, no authentication required
          const response = await fetch(`${API_BASE}/expenses/categories`);
          const data = await response.json();

          if (data.success) {
            const categorySelects = ["expenseCategory", "filterCategory"];
            categorySelects.forEach((selectId) => {
              const select = document.getElementById(selectId);
              select.innerHTML =
                selectId === "filterCategory"
                  ? '<option value="">All categories</option>'
                  : '<option value="">Select category</option>';

              data.data.categories.forEach((category) => {
                const option = document.createElement("option");
                option.value = category;
                option.textContent = category;
                select.appendChild(option);
              });
            });
          }
        } catch (error) {
          console.error("Error loading categories:", error);
        }
      }

      // Set default date to today
      function setDefaultDate() {
        const today = new Date().toISOString().split("T")[0];
        document.getElementById("expenseDate").value = today;
      }

      // Add expense
      async function addExpense() {
        const title = document.getElementById("expenseTitle").value;
        const amount = document.getElementById("expenseAmount").value;
        const category = document.getElementById("expenseCategory").value;
        const date = document.getElementById("expenseDate").value;
        const note = document.getElementById("expenseNote").value;

        try {
          const response = await authenticatedFetch(`${API_BASE}/expenses`, {
            method: "POST",
            body: JSON.stringify({
              title,
              amount: parseFloat(amount),
              category,
              date,
              note,
            }),
          });

          const data = await response.json();
          document.getElementById("expenseResponse").textContent =
            JSON.stringify(data, null, 2);

          if (data.success) {
            // Clear form
            document.getElementById("expenseTitle").value = "";
            document.getElementById("expenseAmount").value = "";
            document.getElementById("expenseCategory").value = "";
            document.getElementById("expenseNote").value = "";
            setDefaultDate();

            // Reload expenses
            loadExpenses();
          }
        } catch (error) {
          document.getElementById("expenseResponse").textContent =
            "Error: " + error.message;
        }
      }

      // Load expenses
      async function loadExpenses() {
        try {
          const category = document.getElementById("filterCategory").value;
          const startDate = document.getElementById("filterStartDate").value;
          const endDate = document.getElementById("filterEndDate").value;
          const search = document.getElementById("filterSearch").value;

          let url = `${API_BASE}/expenses?limit=20`;
          if (category) url += `&category=${encodeURIComponent(category)}`;
          if (startDate) url += `&startDate=${startDate}`;
          if (endDate) url += `&endDate=${endDate}`;
          if (search) url += `&search=${encodeURIComponent(search)}`;

          const response = await authenticatedFetch(url);
          const data = await response.json();

          if (data.success) {
            displayExpenses(data.data.expenses);
            document.getElementById("expenseResponse").textContent = `Loaded ${
              data.data.expenses.length
            } expenses. Total: ‚Çπ${data.data.summary.totalAmount.toFixed(2)}`;
          } else {
            document.getElementById("expenseResponse").textContent =
              JSON.stringify(data, null, 2);
          }
        } catch (error) {
          document.getElementById("expenseResponse").textContent =
            "Error: " + error.message;
        }
      }

      // Display expenses
      function displayExpenses(expenses) {
        const container = document.getElementById("expensesList");

        if (expenses.length === 0) {
          container.innerHTML = "<p>No expenses found.</p>";
          return;
        }

        container.innerHTML = expenses
          .map(
            (expense) => `
                <div class="expense-item">
                    <h5>${expense.title} - ‚Çπ${expense.amount.toFixed(2)}</h5>
                    <p><strong>Category:</strong> ${expense.category}</p>
                    <p><strong>Date:</strong> ${new Date(
                      expense.date
                    ).toLocaleDateString()}</p>
                    ${
                      expense.note
                        ? `<p><strong>Note:</strong> ${expense.note}</p>`
                        : ""
                    }
                    <button class="btn btn-danger" onclick="deleteExpense('${
                      expense._id
                    }')">Delete</button>
                </div>
            `
          )
          .join("");
      }

      // Delete expense
      async function deleteExpense(expenseId) {
        if (!confirm("Are you sure you want to delete this expense?")) return;

        try {
          const response = await authenticatedFetch(
            `${API_BASE}/expenses/${expenseId}`,
            {
              method: "DELETE",
            }
          );

          const data = await response.json();
          document.getElementById("expenseResponse").textContent =
            JSON.stringify(data, null, 2);

          if (data.success) {
            loadExpenses();
          }
        } catch (error) {
          document.getElementById("expenseResponse").textContent =
            "Error: " + error.message;
        }
      }

      // Clear filters
      function clearFilters() {
        document.getElementById("filterCategory").value = "";
        document.getElementById("filterStartDate").value = "";
        document.getElementById("filterEndDate").value = "";
        document.getElementById("filterSearch").value = "";
        loadExpenses();
      }

      // Profile functions
      async function getProfile() {
        try {
          const response = await authenticatedFetch(`${API_BASE}/auth/profile`);
          const data = await response.json();

          if (data.success) {
            currentUser = data.data.user;
            updateAuthStatus(true);

            document.getElementById("profileData").innerHTML = `
                        <div class="alert alert-success">
                            <strong>Username:</strong> ${
                              data.data.user.username
                            }<br>
                            <strong>Email:</strong> ${data.data.user.email}<br>
                            <strong>Weekly Limit:</strong> ‚Çπ${
                              data.data.user.weeklyLimit
                            }<br>
                            <strong>Member Since:</strong> ${new Date(
                              data.data.user.createdAt
                            ).toLocaleDateString()}
                        </div>
                    `;
          }

          document.getElementById("profileResponse").textContent =
            JSON.stringify(data, null, 2);
        } catch (error) {
          document.getElementById("profileResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function updateProfile() {
        const username = document.getElementById("updateUsername").value;
        const email = document.getElementById("updateEmail").value;

        try {
          const response = await authenticatedFetch(
            `${API_BASE}/auth/profile`,
            {
              method: "PUT",
              body: JSON.stringify({ username, email }),
            }
          );

          const data = await response.json();
          document.getElementById("profileResponse").textContent =
            JSON.stringify(data, null, 2);

          if (data.success) {
            currentUser = data.data.user;
            updateAuthStatus(true);
            getProfile();
          }
        } catch (error) {
          document.getElementById("profileResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function changePassword() {
        const currentPassword =
          document.getElementById("currentPassword").value;
        const newPassword = document.getElementById("newPassword").value;

        try {
          const response = await authenticatedFetch(
            `${API_BASE}/auth/change-password`,
            {
              method: "PUT",
              body: JSON.stringify({ currentPassword, newPassword }),
            }
          );

          const data = await response.json();
          document.getElementById("profileResponse").textContent =
            JSON.stringify(data, null, 2);

          if (data.success) {
            document.getElementById("currentPassword").value = "";
            document.getElementById("newPassword").value = "";
          }
        } catch (error) {
          document.getElementById("profileResponse").textContent =
            "Error: " + error.message;
        }
      }

      // Categories functions
      async function loadCategoriesDisplay() {
        try {
          // Categories are now public, no authentication required
          const response = await fetch(`${API_BASE}/expenses/categories`);
          const data = await response.json();

          if (data.success) {
            const categoriesHtml = data.data.categories
              .map(
                (category) =>
                  `<span style="display: inline-block; background: #667eea; color: white; padding: 5px 10px; margin: 5px; border-radius: 15px;">${category}</span>`
              )
              .join("");

            document.getElementById("categoriesDisplay").innerHTML = `
              <div style="margin-top: 15px;">
                <p><strong>Total Categories:</strong> ${data.data.categories.length}</p>
                <div>${categoriesHtml}</div>
              </div>
            `;
          }
        } catch (error) {
          document.getElementById("categoriesDisplay").innerHTML =
            "Error: " + error.message;
        }
      }

      // Reports functions
      async function getMonthlyReport() {
        const year = document.getElementById("monthlyYear").value;
        const month = document.getElementById("monthlyMonth").value;

        try {
          const response = await authenticatedFetch(
            `${API_BASE}/reports/monthly?year=${year}&month=${month}`
          );
          const data = await response.json();
          document.getElementById("reportsResponse").textContent =
            JSON.stringify(data, null, 2);
        } catch (error) {
          document.getElementById("reportsResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function getWeeklyReport() {
        const weekOffset = document.getElementById("weekOffset").value;

        try {
          const response = await authenticatedFetch(
            `${API_BASE}/reports/weekly?weekOffset=${weekOffset}`
          );
          const data = await response.json();
          document.getElementById("reportsResponse").textContent =
            JSON.stringify(data, null, 2);
        } catch (error) {
          document.getElementById("reportsResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function getCategoryReport() {
        const period = document.getElementById("categoryPeriod").value;

        try {
          const response = await authenticatedFetch(
            `${API_BASE}/reports/category?period=${period}`
          );
          const data = await response.json();
          document.getElementById("reportsResponse").textContent =
            JSON.stringify(data, null, 2);
        } catch (error) {
          document.getElementById("reportsResponse").textContent =
            "Error: " + error.message;
        }
      }

      // Email report functions
      async function emailMonthlyReport() {
        const year = document.getElementById("monthlyYear").value;
        const month = document.getElementById("monthlyMonth").value;

        try {
          const response = await authenticatedFetch(
            `${API_BASE}/reports/email/monthly?year=${year}&month=${month}`,
            {
              method: "POST",
            }
          );
          const data = await response.json();
          document.getElementById("reportsResponse").textContent =
            JSON.stringify(data, null, 2);

          if (data.success) {
            alert("üìß Monthly report sent to your email successfully!");
          }
        } catch (error) {
          document.getElementById("reportsResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function emailWeeklyReport() {
        const weekOffset = document.getElementById("weekOffset").value;

        try {
          const response = await authenticatedFetch(
            `${API_BASE}/reports/email/weekly?weekOffset=${weekOffset}`,
            {
              method: "POST",
            }
          );
          const data = await response.json();
          document.getElementById("reportsResponse").textContent =
            JSON.stringify(data, null, 2);

          if (data.success) {
            alert("üìß Weekly report sent to your email successfully!");
          }
        } catch (error) {
          document.getElementById("reportsResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function emailCategoryReport() {
        const period = document.getElementById("categoryPeriod").value;

        try {
          const response = await authenticatedFetch(
            `${API_BASE}/reports/email/category?period=${period}`,
            {
              method: "POST",
            }
          );
          const data = await response.json();
          document.getElementById("reportsResponse").textContent =
            JSON.stringify(data, null, 2);

          if (data.success) {
            alert("üìß Category report sent to your email successfully!");
          }
        } catch (error) {
          document.getElementById("reportsResponse").textContent =
            "Error: " + error.message;
        }
      }

      // Dashboard functions
      async function getDashboard() {
        try {
          const response = await authenticatedFetch(
            `${API_BASE}/users/dashboard`
          );
          const data = await response.json();

          if (data.success) {
            const dashboard = data.data;
            document.getElementById("dashboardData").innerHTML = `
              <div class="alert alert-success">
                <h5>üìä Dashboard Summary</h5>
                <p><strong>Today:</strong> ‚Çπ${dashboard.summary.today.amount.toFixed(
                  2
                )} (${dashboard.summary.today.count} expenses)</p>
                <p><strong>This Week:</strong> ‚Çπ${dashboard.summary.thisWeek.amount.toFixed(
                  2
                )} (${dashboard.summary.thisWeek.count} expenses)</p>
                <p><strong>This Month:</strong> ‚Çπ${dashboard.summary.thisMonth.amount.toFixed(
                  2
                )} (${dashboard.summary.thisMonth.count} expenses)</p>
                ${
                  dashboard.summary.thisWeek.limit > 0
                    ? `
                  <p><strong>Weekly Budget:</strong> ${dashboard.summary.thisWeek.percentage.toFixed(
                    1
                  )}% used
                  ${
                    dashboard.summary.thisWeek.isOverBudget
                      ? "üö® OVER BUDGET"
                      : "‚úÖ"
                  }</p>
                `
                    : ""
                }
              </div>
            `;
          }

          document.getElementById("dashboardResponse").textContent =
            JSON.stringify(data, null, 2);
        } catch (error) {
          document.getElementById("dashboardResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function getWeeklyStatus() {
        try {
          const response = await authenticatedFetch(
            `${API_BASE}/users/weekly-status`
          );
          const data = await response.json();
          document.getElementById("dashboardResponse").textContent =
            JSON.stringify(data, null, 2);
        } catch (error) {
          document.getElementById("dashboardResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function setWeeklyLimit() {
        const weeklyLimit = document.getElementById("weeklyLimitAmount").value;

        try {
          const response = await authenticatedFetch(
            `${API_BASE}/users/weekly-limit`,
            {
              method: "PUT",
              body: JSON.stringify({ weeklyLimit: parseFloat(weeklyLimit) }),
            }
          );

          const data = await response.json();
          document.getElementById("dashboardResponse").textContent =
            JSON.stringify(data, null, 2);

          if (data.success) {
            document.getElementById("weeklyLimitAmount").value = "";
            getDashboard(); // Refresh dashboard
          }
        } catch (error) {
          document.getElementById("dashboardResponse").textContent =
            "Error: " + error.message;
        }
      }

      // Email functions
      async function sendTestEmail() {
        try {
          const response = await authenticatedFetch(
            `${API_BASE}/users/test-email`,
            {
              method: "POST",
            }
          );

          const data = await response.json();
          document.getElementById("emailResponse").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("emailResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function triggerDailySummary() {
        document.getElementById("emailResponse").textContent =
          "Note: Daily summary is automatically triggered by cron jobs. This would require a manual trigger endpoint to be implemented.";
      }

      async function checkWeeklyLimit() {
        document.getElementById("emailResponse").textContent =
          "Weekly limit checking is automatically triggered when expenses are added. Try adding an expense that exceeds your weekly limit.";
      }

      // Cron functions
      async function getCronStatus() {
        try {
          const response = await fetch(`${API_BASE}/status`);
          const data = await response.json();

          if (data.success && data.data.cronJobs) {
            const cronJobs = data.data.cronJobs;
            let statusHtml =
              '<div class="alert alert-success"><h5>Cron Job Status</h5>';

            for (const [jobName, jobInfo] of Object.entries(cronJobs)) {
              const status = jobInfo.running ? "üü¢ Running" : "üî¥ Stopped";
              statusHtml += `
                <p><strong>${jobName}:</strong> ${status}</p>
                <p style="margin-left: 20px; color: #666;">Schedule: ${jobInfo.schedule}</p>
                <p style="margin-left: 20px; color: #666;">${jobInfo.description}</p>
              `;
            }

            statusHtml += "</div>";
            document.getElementById("cronStatusDisplay").innerHTML = statusHtml;
          }

          document.getElementById("cronResponse").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("cronResponse").textContent =
            "Error: " + error.message;
        }
      }

      // New cron testing functions
      async function triggerDailySummary() {
        try {
          const response = await authenticatedFetch(
            `${API_BASE}/cron-test/daily-summary`,
            {
              method: "POST",
            }
          );
          const data = await response.json();
          document.getElementById("cronResponse").textContent = JSON.stringify(
            data,
            null,
            2
          );

          if (data.success) {
            alert(
              `üî• Daily summary triggered! ${data.data.emailsSent} emails sent, ${data.data.emailsFailed} failed.`
            );
          }
        } catch (error) {
          document.getElementById("cronResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function triggerWeeklySummary() {
        try {
          const response = await authenticatedFetch(
            `${API_BASE}/cron-test/weekly-summary`,
            {
              method: "POST",
            }
          );
          const data = await response.json();
          document.getElementById("cronResponse").textContent = JSON.stringify(
            data,
            null,
            2
          );

          if (data.success) {
            alert(
              `üî• Weekly summary triggered! ${data.data.emailsSent} emails sent, ${data.data.emailsFailed} failed.`
            );
          }
        } catch (error) {
          document.getElementById("cronResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function triggerWeeklyLimitCheck() {
        try {
          const response = await authenticatedFetch(
            `${API_BASE}/cron-test/weekly-limit-check`,
            {
              method: "POST",
            }
          );
          const data = await response.json();
          document.getElementById("cronResponse").textContent = JSON.stringify(
            data,
            null,
            2
          );

          if (data.success) {
            alert(`üî• Weekly limit check completed! ${data.message}`);
          }
        } catch (error) {
          document.getElementById("cronResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function testAllCronJobs() {
        try {
          const response = await authenticatedFetch(
            `${API_BASE}/cron-test/test-all`,
            {
              method: "POST",
            }
          );
          const data = await response.json();
          document.getElementById("cronResponse").textContent = JSON.stringify(
            data,
            null,
            2
          );

          if (data.success) {
            const summary = data.data.summary;
            alert(
              `üß™ All cron jobs tested! ${summary.successCount}/${summary.totalTests} successful.`
            );
          }
        } catch (error) {
          document.getElementById("cronResponse").textContent =
            "Error: " + error.message;
        }
      }

      // Legacy functions (kept for compatibility)
      async function manualDailySummary() {
        await triggerDailySummary();
      }

      async function manualWeeklyCheck() {
        await triggerWeeklyLimitCheck();
      }

      // System status functions
      async function getSystemStatus() {
        try {
          const response = await fetch(`${API_BASE}/status`);
          const data = await response.json();

          if (data.success) {
            const status = data.data;
            document.getElementById("systemStatusDisplay").innerHTML = `
              <div class="alert alert-success">
                <h5>System Status</h5>
                <p><strong>API:</strong> ${status.api}</p>
                <p><strong>Database:</strong> ${status.database}</p>
                <p><strong>Uptime:</strong> ${Math.floor(
                  status.uptime / 60
                )} minutes</p>
                <p><strong>Memory Usage:</strong> ${Math.round(
                  status.memory.heapUsed / 1024 / 1024
                )} MB</p>
                <p><strong>Timestamp:</strong> ${new Date(
                  status.timestamp
                ).toLocaleString()}</p>
              </div>
            `;
          }

          document.getElementById("statusResponse").textContent =
            JSON.stringify(data, null, 2);
        } catch (error) {
          document.getElementById("statusResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function healthCheck() {
        try {
          const response = await fetch("http://localhost:5000/health");
          const data = await response.json();
          document.getElementById("statusResponse").textContent =
            JSON.stringify(data, null, 2);
        } catch (error) {
          document.getElementById("statusResponse").textContent =
            "Error: " + error.message;
        }
      }

      async function testDatabaseConnection() {
        try {
          const response = await fetch(`${API_BASE}/status`);
          const data = await response.json();

          if (data.success) {
            const dbStatus =
              data.data.database === "connected"
                ? "‚úÖ Connected"
                : "‚ùå Disconnected";
            document.getElementById("databaseStatus").innerHTML = `
              <div class="alert ${
                data.data.database === "connected"
                  ? "alert-success"
                  : "alert-error"
              }">
                <strong>Database Status:</strong> ${dbStatus}
              </div>
            `;
          }
        } catch (error) {
          document.getElementById("databaseStatus").innerHTML = `
            <div class="alert alert-error">
              <strong>Database Status:</strong> ‚ùå Error - ${error.message}
            </div>
          `;
        }
      }

      // Documentation functions
      async function getApiDocs() {
        try {
          const response = await fetch(`${API_BASE}/docs`);
          const data = await response.json();

          if (data.success) {
            let docsHtml =
              '<div class="alert alert-success"><h5>API Documentation</h5>';

            for (const [section, endpoints] of Object.entries(
              data.documentation
            )) {
              docsHtml += `<h6 style="margin-top: 20px; color: #667eea;">${section.toUpperCase()}</h6>`;
              for (const [endpoint, description] of Object.entries(endpoints)) {
                docsHtml += `<p><code>${endpoint}</code> - ${description}</p>`;
              }
            }

            docsHtml += "</div>";
            document.getElementById("apiDocsDisplay").innerHTML = docsHtml;
          }

          document.getElementById("docsResponse").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          document.getElementById("docsResponse").textContent =
            "Error: " + error.message;
        }
      }

      // Set current month as default
      document.addEventListener("DOMContentLoaded", function () {
        const currentMonth = new Date().getMonth() + 1;
        if (document.getElementById("monthlyMonth")) {
          document.getElementById("monthlyMonth").value = currentMonth;
        }
      });
    </script>
  </body>
</html>
